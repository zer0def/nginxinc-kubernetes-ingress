apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend1
  template:
    metadata:
      labels:
        app: backend1
    spec:
      containers:
      - name: backend1
        image: nginxdemos/nginx-hello:plain-text
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: backend1-svc
spec:
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: backend1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend2
  template:
    metadata:
      labels:
        app: backend2
    spec:
      containers:
      - name: backend2
        image: nginx
        ports:
        - containerPort: 80
        volumeMounts:
          - name: secret
            mountPath: "/etc/nginx/ssl"
            readOnly: true
          - name: config-volume
            mountPath: /etc/nginx/conf.d
      volumes:
      - name: secret
        secret:
          secretName: app-tls-secret
      - name: config-volume
        configMap:
          name: secure-config
---
apiVersion: v1
kind: Service
metadata:
  name: backend2-svc
spec:
  ports:
  - port: 80
    targetPort: 443
    protocol: TCP
    name: https
  selector:
    app: backend2
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: secure-config
data:
  app.conf: |-
    server {
      listen 443 ssl;
      listen [::]:443 ssl;

      server_name app.example.com;

      ssl_certificate /etc/nginx/ssl/tls.crt;
      ssl_certificate_key /etc/nginx/ssl/tls.key;

      default_type text/plain;

      location / {
        return 200 "here is your response via ssl port $server_port with X-Forwarded-Port $http_x_forwarded_port\n";
      }
    }
---
apiVersion: v1
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZvekNDQTR1Z0F3SUJBZ0lVUnlPSlVVZmVXUmMvenpCK01hYkN4ZWhOMzdjd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1ZqRUxNQWtHQTFVRUJoTUNTVVV4RFRBTEJnTlZCQWdNQkVOdmNtc3hEakFNQmdOVkJBb01CVTVIU1U1WQpNUTR3REFZRFZRUUxEQVZPUjBsT1dERVlNQllHQTFVRUF3d1BZWEJ3TG1WNFlXMXdiR1V1WTI5dE1CNFhEVEkwCk1UQXlPVEUzTURZMU4xb1hEVE0wTVRBeU56RTNNRFkxTjFvd1ZqRUxNQWtHQTFVRUJoTUNTVVV4RFRBTEJnTlYKQkFnTUJFTnZjbXN4RGpBTUJnTlZCQW9NQlU1SFNVNVlNUTR3REFZRFZRUUxEQVZPUjBsT1dERVlNQllHQTFVRQpBd3dQWVhCd0xtVjRZVzF3YkdVdVkyOXRNSUlDSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQWc4QU1JSUNDZ0tDCkFnRUF1VmcvMlNyWFFtM3FqeUNYYThINmcxMkpyYStzSGIzdnJScHh2SDNmbVJxR3JGK2t2RjJDa1lCcFF3ckkKWVAxeHJyMnI3TjNuMGlQR2hRclJxdjIrYm4zdTM0ZjhiaW5ZRmt1WmRKTkVaajB6b0o4eTZCN0dQVGhnLzg3cgpDRnR3NkdFaVh5K29BZXlVVzFGcHlxbld4QUcxRGpNek9RS1h2SjB6SXpBZEorWkluVmhiS1RpNHVkNnphaklJCklEY2pnYzdVUEh4bTlncDY4d1MvaUVMbWxFR2dlOC9CeE1NcGVqcmJsOTJvMXNybU02WU1ldXI1RStWZkowUWgKVHVwR1hyRVdySGNoT1F6akwyU0lOM09jVmp1SzVrUEdBNXh6WHllcUtjWkVJazZmdXlBaW5aLzJNL1JRL3F5eAo0RTB2MEVIbGpzN3UyTkdmQ2tudVZoZFhld28zMXRLUUI4ZnJiM29BRUNWYmk4cDdvdGxSalpLVE1FQXRlNkV4ClpmckdiVThObmJNRlVEV3lHZERnT1Q3a28xaFNSc3ZoM3h6cGk0V0pYSjZHYnpYdkxoenJyd0k2WjdDeHkrdDUKdzFPbFpOUFlQOGtSK1hHa3Vrb1RkSGplSWZZdGhtN04rYUxmdXU0ektFOUpGcWx6Szl4L3h6RFFUK1g0REpCMQp3UmpmcW9lQm9IMGxmN0l1MlpRK25VbVpIdEh4RFhSUFY0U1lESW42Q2JwaHF1ZnJZTEk3SExJMFZ4Y2Uwd1lZCnhoNlhzNHNydEFnZHJ1bUU0ek5URm56aHA3UjAyRktnbmxrWlBsYXZkSkJFaDlvLzU0NmFZSE44UmxEQzJLV2MKNWh5SmtxOVJlZE5YTTBxMjJpWDBndlVDMVR5MklxaTJmT2ZMS0krMGdMTUJSa0VDQXdFQUFhTnBNR2N3SFFZRApWUjBPQkJZRUZJU016S1lzVnZyMjM1VXp6Zmw1UGkwVEw4L3lNQjhHQTFVZEl3UVlNQmFBRklTTXpLWXNWdnIyCjM1VXp6Zmw1UGkwVEw4L3lNQm9HQTFVZEVRUVRNQkdDRDJGd2NDNWxlR0Z0Y0d4bExtTnZiVEFKQmdOVkhSTUUKQWpBQU1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQ0FRQTE4VHorS0IxbG5tM2hFSStOQ2ZWWlRTMlpmVUZxVTU2Uwp2MEwvejROWGhsWmhnZTNLckx0RGhPNTFsSWNqa2I2WlU2M25RUkp1bFJDbStGejdPdys2eGNoeUJWOFRNMmRsCnU4aEJwOXkxRDVXUTlLdmVPQU40b2E4U245OVdEcTBtUEIyUmpEUDRRMFo3bXE0QXpUdG40ZlhKQUdNWit0NUUKUWtZVGpJTktYTzk3cGtlRUdlOXg0dDAwWk04NHFJMnlRTW5hdkQzL2czK1phbkFiRXEySGEva25QaENrVnFwVQpoL2RHTTFiYWg4QmhLMW9QY3VvMWgwSFcrTzFzdktLelgzYXEzS3k2eHRSbTRST1BCR0hRVnA5TnR3b09LcSt2CjdtdmRybHZmVzV1VnhZQUE2eGlJZkQxWStacUVYUFdGZXZJUjdhU01TZ0ZIOG0rWVJ2NTFlMXZUOHkwNG1TWVQKRTI0aFpjRGw4ZWxMMXIvRmsrUzg2M1g0bk9BY1cwZTZxYTFpVkQveWhKdGhKWjI4NkhsSVAxc3J5WmJmd0ZNNgpLWFhBVHpvSWE1YUt2ajdic2JtaVpDZS9nd1RxNWpxNXJCK0FmNnk4dVBMaHRPMUFWSVdxaGpZSEgwcmlWdFk1ClpjN2hLWTdvUGhXeTVod1czOUtLT2lZbUgwbHRvdjFhT2xLL0ovVGI2YmdpZ00xZTNNbGhqQWxqVEErd1JhdDcKYXBUSDMvWnVhNUpweG9tdXlaelVQVHd1dnhic0NaNm41bHpqNXZYMVgzdWY4Y3lrNFdoRk1zbnVwTXFLOFJ3SApxUXFpdDBTUlVIRk9DaUVaNEVtSzI0OERHUVBrU051Y0MyZDVTVFZwcVVQSlE1YnpjZWlYRmIxWUFUN3JZT2ltCk5ON3J4Q2tVcEE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUpRZ0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQ1N3d2dna29BZ0VBQW9JQ0FRQzVXRC9aS3RkQ2JlcVAKSUpkcndmcURYWW10cjZ3ZHZlK3RHbkc4ZmQrWkdvYXNYNlM4WFlLUmdHbERDc2hnL1hHdXZhdnMzZWZTSThhRgpDdEdxL2I1dWZlN2ZoL3h1S2RnV1M1bDBrMFJtUFRPZ256TG9Ic1k5T0dEL3p1c0lXM0RvWVNKZkw2Z0I3SlJiClVXbktxZGJFQWJVT016TTVBcGU4blRNak1CMG41a2lkV0ZzcE9MaTUzck5xTWdnZ055T0J6dFE4ZkdiMkNucnoKQkwrSVF1YVVRYUI3ejhIRXd5bDZPdHVYM2FqV3l1WXpwZ3g2NnZrVDVWOG5SQ0ZPNmtaZXNSYXNkeUU1RE9NdgpaSWczYzV4V080cm1ROFlEbkhOZko2b3B4a1FpVHArN0lDS2RuL1l6OUZEK3JMSGdUUy9RUWVXT3p1N1kwWjhLClNlNVdGMWQ3Q2pmVzBwQUh4K3R2ZWdBUUpWdUx5bnVpMlZHTmtwTXdRQzE3b1RGbCtzWnRUdzJkc3dWUU5iSVoKME9BNVB1U2pXRkpHeStIZkhPbUxoWWxjbm9adk5lOHVIT3V2QWpwbnNMSEw2M25EVTZWazA5Zy95Ukg1Y2FTNgpTaE4wZU40aDlpMkdiczM1b3QrNjdqTW9UMGtXcVhNcjNIL0hNTkJQNWZnTWtIWEJHTitxaDRHZ2ZTVi9zaTdaCmxENmRTWmtlMGZFTmRFOVhoSmdNaWZvSnVtR3E1K3Rnc2pzY3NqUlhGeDdUQmhqR0hwZXppeXUwQ0IydTZZVGoKTTFNV2ZPR250SFRZVXFDZVdSaytWcTkwa0VTSDJqL25qcHBnYzN4R1VNTFlwWnptSEltU3IxRjUwMWN6U3JiYQpKZlNDOVFMVlBMWWlxTFo4NThzb2o3U0Fzd0ZHUVFJREFRQUJBb0lDQUJvRVBlSWtBS3lvZFN1N2JYQ0kwcnRYCk0rNUNJZGVDN241NVNjeDY5c1NzL29rbEJuWVNiTjR6dDVMYmsvT3V0U01oZmdmMUZqSUowamRMK2lackVTeTkKVjFIZjZzVWo4VEIxVXQyKzY1NVdWUEE2VXp1clVOOE52T3FXTWFrRFVqNnNTU3VIVmFsVTBNdXpYK0E4MEQxdgpQVCtqQnVaU2E0T08rcnRPYVA2aXlwVkdROHJ1S3EveDNNbGtBSDZxZnJ6SDVabDFTa0ZGM2dCTmd2MHVOdU9mCldxeEdlM0tTaFRpaWJtbjJOQVJYM1h4cEt6Tk4xeGRvaVFvZi9CK2NXYk1OQ2ZFU1A5aEc2MytlNHYxZ1V4VDEKQXJMK2djWEdxTzNnZENNQ1c2b0gwMUFYQmdUamkveGxwOERpbmpnQ3N3VjVXb1J6U1ArbnNtVmxWS1B0Q1lXcAp1NjJFY203OXh1Qys1WUlaQ2pTYlFLZUJPRkEzN01YMkpXanBBanZhZVhSZ2EwQjRnSXRKNEIvOEZ5UUJlNzVwCmJDTkw0VFpGMndMY01pU05lTWNKRmQ4eUJqbjJsZEgyeGg1YTM0L0lsNzdsa29FeHBFVHl4NVkxSkg2WlJqKzQKZVE2SnpaRWwzZkZ4eGtFSy9IalRVUUp5TVZFTEdCNnNFVURlVGxjYmhvcFZMYSsxTVgzVGRSdGJHNC9CY1VJbwpiNHBsZnRrdG81d3dSU0oza1c5RDBuc3MyTlh1UDE0R1JSZmw0L1VqSWtWUXpCR0dhcU5ub2tUaks2OGl4Yzg4CjhWTSt0QTJhUVNzM3FnV1lPQ0pBdnZRK2IxZFlFK0g2MDkzbzFWL052QkhKYjhxb2lsbjFvcXJNTWt6NC95M2QKNi9XbzdCL2xzM0ZSRjFsc2hVbnBBb0lCQVFEeWVpdjRrQk9meDU5Y0NaaFVOWFJ4U3NUVnpENFNmMHlsQ09kYgpwYk1KWnVVbnRNYlYxVzNiZzRFV0tYYVZMaVVvRjJ6byt6WlVYNmxzNGNqOEVyc2I1VjVDNXVqdjJmYkxFeFBTCm9FeGt4WFpRaFNtYTdCSHdDeUEzZlNoZDlLNWNoVE1vVWxKVStIT0ttcjBYUFV5Nm90YldSaFRiWmVxS2s3SjIKM0ZkUVhiOE80TzdUSllHSzVlTERCcW1UTXR0dGw2SllDdzhuNm83dXZuRXB6MjM0OGlYZ21HZWRxS0FPMjRIUQp1dDdQMzNSUWdSVWdwZXhOYWkrRHdLQ2cveGdkdlloSVEzSXlWelJKK3pQNXFhTFRGSzhQRHJjSHJHSzZLeG9vCms1ZnpTR1haWGVjM3pwWGE4L0tqVlZqR2p0SXNaODA3eDlGV09SaWVpSndjTWxJbkFvSUJBUUREcm1hK1VrMnUKNStBUFBuRGh2cFNieHJwejg0dEV1SGUzL1lRb0pWdy9kYVFLZllkekR6MEY2cEh1N05zRjR2SlVPV0pSV0l2VQp1b3M5TVZ4U3NsdTVOVmlIRWVQdnc3d2xheE5yZTVLbFJmSDJ6eTI4d1JOeUNkbjdsT0EvOUpMYjRxUzJxaG1aCnpvTXdzbWYwMDZ5TllnY3p1TDV2elNlMENTMzZGVEM5UmxXaVM0MXRDcWFCY005VkhlWkF1NG9vZUxyTXdVbEwKYTc4MXQxWVhkMUI0a0JGRExJY1BQYWlxSGdFY1FGY05wOURleTVRcTVtamlhRHdyb2VmZUFyK1pYelFqSzBjRwpXRGJpcGpFZ3NoY1RWNjVXNUJaTkJNTEV0NnVWT3NqVmE5dXo1czVrUWVydHppS0UxZ0plcGJCZGMwaFNYeXBwCit2SW1zYmFWWmExWEFvSUJBUUNFL3JHamNoTHhibUpmN3Z0WUpNR3JhaUV3U3dnNHlRM1c3MTFHalVuMy9ESHcKWjEwdjZCS0xka09WVGtTMmFrc0RCR1krRzV1ZkI2RThFVk5WdjBoVmNxY1M5dWdJdG5xQXhBUDVZT2JGMXZDZwpGWW5PYVhFbFFsVDNXblNMcENzR29DQ0JHellCV1F5Mmwwemp0RUdqbExGVmNiYjY1NW1QVEpkMFRrS3QxOTExClliWmNwWk82QllFdEN6aHpmaytRZXIwV29XbzhzSkNaTG1lUFVUQzJmTXA5dDlvTlJYSVU5Qnp0eWJGd1B0WGoKV2dtbWtKdGRrc0pnOTRTakNZZkd1REJKd29TZVMrcG9NWm8rYytiVTgrRlkxdTlaREJwU2xsV1FyL09HQXMycQpQYkVXa1A3c3l5VG9wV1U5OHhRZ093YjhwUXFTeWxwUWlnbG1CY3U5QW9JQkFBODJkTWhoRDZjRVlkZnRpOHNSCkRPNmJZWTE0SnFDZUVyaWNIZlVkQ25Ib2pHdEFYUkpsNGVHZTNkK01URzdGdVA4eFF1SitGc2pnQThrckdEbFoKb21YZ3J0UTVZTllZQ24yQ09JMUhteHY4Tnhadi91ZEl2MkZEUU00ZFFkM1cvci9YZStTempxLzFiUitSRHlIcQpmdVN5OVVwaEYzVUxwd1dKSFNqdkVzMzBOTjRjTDQrRm4zSTZ1Zk90RW1SLzcvcTdnQkpCQ0ppemRMY1JYTUVRClJwSkk2UDZtN0kwVHh4UUtweDF5SnhKcHRJUk5vV1JBYTNFR2wzN3c1RnpQSytRWmthMFdSVHhLQ1dKUGQweEsKYkI3VjF6anNISXU2VGdZTEhXekptQ2wzYkNvdFRHaGc4NG12VitHcDNaOU1GRXovbEdUSy96b2tCMFZZMVpBQgp5cHNDZ2dFQUVTb0xNd0VvN3dWNDVlQ3JVOWNoMzBnSHY3RUpnYStLeGNHMjBPT0RKcEZMVVViYlZ0ZVQ5aFBUCnJSZ0l6WDUzNGZxVmVKQ2Zpdy9xZW56RS9wcjlBcW8rNjYrYWdDN1JlRUMyeS83R2kxWEdwcThJa3hKZEtzUEsKVjFqbk9sdmpMU0lSV3RVdGRwSmlhdTBWcTAzZW1GVDNERFJJTTF3RkhjK0hQakNwVER3bDh1WDRscmlPWlFJdApRbnhjRUFSbzNIMkdudmpSZ2xxZ1Z2S0NPaWF2anozalBpaEpGZjVCRjR6YzlkdWZVajhBSjVhd2J1SDFLSHJ4ClIzYXFSamUzSTV0eDVJU0FXTVhjRmVXWDhucUZJUDM5L0V5TE5xRHQ2enQrUkZETU4xNGx2WVNLQ01KNVA5RUIKazB1RU0xQ2pzeWtwNnNlT2lyTEVYWW01QWpvZDNBPT0KLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLQo=
kind: Secret
metadata:
  name: app-tls-secret
type: Opaque
