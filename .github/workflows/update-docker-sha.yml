name: "Update pinned container SHAs"
run-name: Update pinned container SHAs, triggered from ${{ github.event_name }} by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      source_branch:
        required: true
        type: string
        default: "main"
      excludes:
        description: Comma separated list of strings to exclude images from the update
        required: false
        type: string
        default: ""
      dry_run:
        type: boolean
        default: false

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  vars:
    permissions:
      contents: read
    runs-on: ubuntu-24.04
    outputs:
      source_branch: ${{ steps.vars.outputs.source_branch }}
    steps:
      - name: Set vars
        id: vars
        run: |
          source_branch=main
          if [ -n "${{ inputs.source_branch }}" ]; then
            source_branch=${{ inputs.source_branch }}
          fi
          echo "source_branch=${source_branch}" >> $GITHUB_OUTPUT

  update-docker-sha:
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    runs-on: ubuntu-24.04
    needs: [vars]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ needs.vars.outputs.source_branch }}

      - name: Update images
        id: update_images
        run: |
          ARGS=""
          if [ -n ${{ github.event.inputs.excludes }} ]; then
            ARGS="--exclude ${{ github.event.inputs.excludes }}"
          fi
          .github/scripts/docker-updater.sh ./build/Dockerfile $ARGS
          .github/scripts/docker-updater.sh ./build/dependencies/Dockerfile.ubi8 $ARGS
          .github/scripts/docker-updater.sh ./build/dependencies/Dockerfile.ubi9 $ARGS
          .github/scripts/docker-updater.sh ./tests/Dockerfile $ARGS
          files=$(git diff --name-only)
          if [[ $files == *"Dockerfile"* ]]; then
            echo "change_detected=true" >> $GITHUB_OUTPUT
          else
            echo "change_detected=false" >> $GITHUB_OUTPUT
          fi
          docker_md5=$(find . -type f -name "Dockerfile*" -exec md5sum {} + | LC_ALL=C sort  | md5sum | awk '{ print $1 }')
          echo "docker_md5=${docker_md5:0:8}" >> $GITHUB_OUTPUT
          echo $GITHUB_OUTPUT

      - name: Azure login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
        with:
          client-id: ${{ secrets.AZURE_COMMON_VAULT_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_COMMON_VAULT_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_COMMON_VAULT_SUBSCRIPTION_ID }}

      - name: Setup secrets
        id: secrets
        run: |
          echo "Setting secrets for job"
          NGINX_PAT=$(az keyvault secret show --name nginx-bot-pat --vault-name ${{ secrets.COMMON_KEYVAULT_NAME }} --query value -o tsv)
          echo "::add-mask::$NGINX_PAT"
          echo "NGINX_PAT=$NGINX_PAT" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        id: pr
        with:
          token: ${{ steps.secrets.outputs.NGINX_PAT }}
          commit-message: Update docker images ${{ steps.update_images.outputs.docker_md5 }}
          title: Docker image update ${{ steps.update_images.outputs.docker_md5 }}
          branch: deps/image-update-${{ needs.vars.outputs.source_branch }}-${{ steps.update_images.outputs.docker_md5 }}
          author: nginx-bot <integrations@nginx.com>
          labels: |
            dependencies
            docker
            needs cherry pick
          body: |
            This automated PR updates pinned container image SHAs to latest.
        if: ${{ !inputs.dry_run && steps.update_images.outputs.change_detected == 'true' }}

      - name: Enable auto-merge for Docker update PRs
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ steps.pr.outputs.pull-request-url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: ${{ !inputs.dry_run && steps.update_images.outputs.change_detected == 'true' }}
